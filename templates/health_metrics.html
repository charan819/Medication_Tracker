{% extends "base.html" %}

{% block title %}Health Metrics - Health Management App{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Your Health Metrics</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMetricModal">
        <i class="fas fa-plus me-1"></i> Add Metric
    </button>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Filters</h5>
        <div class="row g-3">
            <div class="col-md-3">
                <label for="metricTypeFilter" class="form-label">Metric Type</label>
                <select class="form-select" id="metricTypeFilter">
                    <option value="">All</option>
                    <option value="blood_pressure">Blood Pressure</option>
                    <option value="glucose">Blood Glucose</option>
                    <option value="weight">Weight</option>
                    <option value="heart_rate">Heart Rate</option>
                    <option value="temperature">Temperature</option>
                    <option value="oxygen">Oxygen Saturation</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="fromDateFilter" class="form-label">From Date</label>
                <input type="date" class="form-control" id="fromDateFilter">
            </div>
            <div class="col-md-3">
                <label for="toDateFilter" class="form-label">To Date</label>
                <input type="date" class="form-control" id="toDateFilter">
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary w-100" id="applyFilters">Apply Filters</button>
            </div>
        </div>
    </div>
</div>

<!-- Health Metrics List -->
<div class="card">
    <div class="card-body">
        <div class="loader text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="metrics-container">
            <!-- Health metrics will be loaded here -->
        </div>
    </div>
</div>

<!-- Add Health Metric Modal -->
<div class="modal fade" id="addMetricModal" tabindex="-1" aria-labelledby="addMetricModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMetricModalLabel">Add New Health Metric</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addMetricForm">
                    <div class="mb-3">
                        <label for="metric_type" class="form-label">Metric Type</label>
                        <select class="form-select" id="metric_type" name="metric_type" required>
                            <option value="" selected disabled>Select metric type</option>
                            <option value="blood_pressure">Blood Pressure</option>
                            <option value="glucose">Blood Glucose</option>
                            <option value="weight">Weight</option>
                            <option value="heart_rate">Heart Rate</option>
                            <option value="temperature">Temperature</option>
                            <option value="oxygen">Oxygen Saturation</option>
                        </select>
                    </div>
                    
                    <!-- Fields for regular metrics -->
                    <div id="regular-metric-fields">
                        <div class="mb-3">
                            <label for="value" class="form-label">Value</label>
                            <input type="number" step="0.01" class="form-control" id="value" name="value">
                        </div>
                    </div>
                    
                    <!-- Fields for blood pressure -->
                    <div id="blood-pressure-fields" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="systolic" class="form-label">Systolic (mmHg)</label>
                                <input type="number" class="form-control" id="systolic" name="systolic">
                            </div>
                            <div class="col-md-6">
                                <label for="diastolic" class="form-label">Diastolic (mmHg)</label>
                                <input type="number" class="form-control" id="diastolic" name="diastolic">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="unit" class="form-label">Unit</label>
                        <input type="text" class="form-control" id="unit" name="unit" required>
                        <small class="form-text text-muted">e.g., mmHg, mg/dL, kg, bpm, etc.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="recorded_at" class="form-label">Time Recorded</label>
                        <input type="datetime-local" class="form-control" id="recorded_at" name="recorded_at">
                        <small class="form-text text-muted">Leave blank to use current time</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMetricBtn">Save Metric</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        // Load health metrics on page load
        await loadHealthMetrics();
        
        // Set up event listeners
        document.getElementById('applyFilters').addEventListener('click', loadHealthMetrics);
        document.getElementById('saveMetricBtn').addEventListener('click', saveHealthMetric);
        
        // Toggle fields based on metric type
        document.getElementById('metric_type').addEventListener('change', function() {
            const metricType = this.value;
            const regularFields = document.getElementById('regular-metric-fields');
            const bpFields = document.getElementById('blood-pressure-fields');
            
            if (metricType === 'blood_pressure') {
                regularFields.style.display = 'none';
                bpFields.style.display = 'block';
                
                // Set default unit for blood pressure
                document.getElementById('unit').value = 'mmHg';
            } else {
                regularFields.style.display = 'block';
                bpFields.style.display = 'none';
                
                // Set default units based on metric type
                let defaultUnit = '';
                switch(metricType) {
                    case 'glucose':
                        defaultUnit = 'mg/dL';
                        break;
                    case 'weight':
                        defaultUnit = 'kg';
                        break;
                    case 'heart_rate':
                        defaultUnit = 'bpm';
                        break;
                    case 'temperature':
                        defaultUnit = 'Â°C';
                        break;
                    case 'oxygen':
                        defaultUnit = '%';
                        break;
                }
                document.getElementById('unit').value = defaultUnit;
            }
        });
    });
    
    async function loadHealthMetrics() {
        try {
            showLoader();
            
            // Get filter values
            const metricType = document.getElementById('metricTypeFilter').value;
            const fromDate = document.getElementById('fromDateFilter').value;
            const toDate = document.getElementById('toDateFilter').value;
            
            // Create filters object
            const filters = {};
            if (metricType) filters.metric_type = metricType;
            if (fromDate) filters.from_date = fromDate;
            if (toDate) filters.to_date = toDate;
            
            // Fetch health metrics
            const metrics = await fetchHealthMetrics(filters);
            
            // Display health metrics
            const container = document.getElementById('metrics-container');
            
            if (metrics.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-5">
                        <h5>No health metrics found</h5>
                        <p>Add a health metric to get started</p>
                    </div>
                `;
                hideLoader();
                return;
            }
            
            // Group metrics by type
            const metricsByType = {};
            metrics.forEach(metric => {
                if (!metricsByType[metric.metric_type]) {
                    metricsByType[metric.metric_type] = [];
                }
                metricsByType[metric.metric_type].push(metric);
            });
            
            let html = '';
            
            // Display each metric type in its own section
            for (const [type, metricsOfType] of Object.entries(metricsByType)) {
                const typeDisplay = type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                html += `
                    <div class="mb-4">
                        <h4>${typeDisplay}</h4>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                `;
                
                // Custom headers based on metric type
                if (type === 'blood_pressure') {
                    html += `
                        <th>Date & Time</th>
                        <th>Systolic</th>
                        <th>Diastolic</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    `;
                } else {
                    html += `
                        <th>Date & Time</th>
                        <th>Value</th>
                        <th>Unit</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    `;
                }
                
                html += `
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Add rows for each metric
                metricsOfType.forEach(metric => {
                    if (type === 'blood_pressure') {
                        html += `
                            <tr>
                                <td>${formatDate(metric.recorded_at)} ${formatTime(metric.recorded_at)}</td>
                                <td>${metric.systolic}</td>
                                <td>${metric.diastolic}</td>
                                <td>${metric.notes || '-'}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteMetricConfirm(${metric.id})">
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        html += `
                            <tr>
                                <td>${formatDate(metric.recorded_at)} ${formatTime(metric.recorded_at)}</td>
                                <td>${metric.value}</td>
                                <td>${metric.unit}</td>
                                <td>${metric.notes || '-'}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteMetricConfirm(${metric.id})">
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                `;
            }
            
            container.innerHTML = html;
            hideLoader();
            
        } catch (error) {
            console.error('Error loading health metrics:', error);
            showAlert('Failed to load health metrics. Please try again later.', 'danger');
            hideLoader();
        }
    }
    
    async function saveHealthMetric() {
        const metricType = document.getElementById('metric_type').value;
        
        if (!metricType) {
            showAlert('Please select a metric type', 'warning');
            return;
        }
        
        let metricData = {
            metric_type: metricType,
            unit: document.getElementById('unit').value,
            notes: document.getElementById('notes').value || null
        };
        
        const recordedAt = document.getElementById('recorded_at').value;
        if (recordedAt) {
            metricData.recorded_at = new Date(recordedAt).toISOString();
        }
        
        // Add specific fields based on metric type
        if (metricType === 'blood_pressure') {
            const systolic = document.getElementById('systolic').value;
            const diastolic = document.getElementById('diastolic').value;
            
            if (!systolic || !diastolic) {
                showAlert('Please enter both systolic and diastolic values', 'warning');
                return;
            }
            
            metricData.systolic = parseFloat(systolic);
            metricData.diastolic = parseFloat(diastolic);
            metricData.value = parseFloat(systolic); // Use systolic as the main value for visualization
        } else {
            const value = document.getElementById('value').value;
            
            if (!value) {
                showAlert('Please enter a value', 'warning');
                return;
            }
            
            metricData.value = parseFloat(value);
        }
        
        try {
            showLoader();
            const response = await fetch('/api/health-metrics', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(metricData),
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
            }
            
            hideLoader();
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('addMetricModal'));
            modal.hide();
            document.getElementById('addMetricForm').reset();
            
            showAlert('Health metric saved successfully!', 'success');
            
            // Reload health metrics
            await loadHealthMetrics();
            
        } catch (error) {
            hideLoader();
            console.error('Error saving health metric:', error);
            showAlert('Failed to save health metric. Please try again.', 'danger');
        }
    }
    
    async function deleteMetricConfirm(metricId) {
        if (confirm('Are you sure you want to delete this health metric? This action cannot be undone.')) {
            try {
                showLoader();
                const response = await fetch(`/api/health-metrics/${metricId}`, {
                    method: 'DELETE',
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                hideLoader();
                showAlert('Health metric deleted successfully!', 'success');
                
                // Reload health metrics
                await loadHealthMetrics();
                
            } catch (error) {
                hideLoader();
                console.error('Error deleting health metric:', error);
                showAlert('Failed to delete health metric. Please try again.', 'danger');
            }
        }
    }
</script>
{% endblock %}