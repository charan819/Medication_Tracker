{% extends "base.html" %}

{% block title %}Reminders - Health Management App{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Your Reminders</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReminderModal">
        <i class="fas fa-plus me-1"></i> Add Reminder
    </button>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Filters</h5>
        <div class="row g-3">
            <div class="col-md-3">
                <label for="typeFilter" class="form-label">Reminder Type</label>
                <select class="form-select" id="typeFilter">
                    <option value="">All</option>
                    <option value="medication">Medication</option>
                    <option value="appointment">Appointment</option>
                    <option value="health_check">Health Check</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter">
                    <option value="">All</option>
                    <option value="true" selected>Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary w-100" id="applyFilters">Apply Filters</button>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100" id="resetFilters">Reset</button>
            </div>
        </div>
    </div>
</div>

<!-- Reminders List -->
<div class="card">
    <div class="card-body">
        <div class="loader text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="reminders-container">
            <!-- Reminders will be loaded here -->
        </div>
    </div>
</div>

<!-- Add Reminder Modal -->
<div class="modal fade" id="addReminderModal" tabindex="-1" aria-labelledby="addReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addReminderModalLabel">Add New Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addReminderForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="reminder_type" class="form-label">Reminder Type</label>
                            <select class="form-select" id="reminder_type" name="reminder_type" required>
                                <option value="" selected disabled>Select reminder type</option>
                                <option value="medication">Medication</option>
                                <option value="appointment">Appointment</option>
                                <option value="health_check">Health Check</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="target-container">
                            <label for="target_id" class="form-label">Select Target</label>
                            <select class="form-select" id="target_id" name="target_id">
                                <option value="">None</option>
                                <!-- Options will be loaded dynamically based on the selected type -->
                            </select>
                            <small class="form-text text-muted">Optional: Connect this reminder to a specific item</small>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="message" class="form-label">Message</label>
                        <textarea class="form-control" id="message" name="message" rows="3" required></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="reminder_date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="reminder_date" name="reminder_date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="reminder_time" class="form-label">Time</label>
                            <input type="time" class="form-control" id="reminder_time" name="reminder_time" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="repeat_interval" class="form-label">Repeat</label>
                            <select class="form-select" id="repeat_interval" name="repeat_interval">
                                <option value="once">Once</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="notification_method" class="form-label">Notification Method</label>
                            <select class="form-select" id="notification_method" name="notification_method">
                                <option value="app">App Notification</option>
                                <option value="email">Email</option>
                                <option value="sms">SMS</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveReminderBtn">Save Reminder</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Reminder Modal -->
<div class="modal fade" id="editReminderModal" tabindex="-1" aria-labelledby="editReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editReminderModalLabel">Edit Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editReminderForm">
                    <input type="hidden" id="edit_reminder_id">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_reminder_type" class="form-label">Reminder Type</label>
                            <select class="form-select" id="edit_reminder_type" name="reminder_type" required>
                                <option value="medication">Medication</option>
                                <option value="appointment">Appointment</option>
                                <option value="health_check">Health Check</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="edit-target-container">
                            <label for="edit_target_id" class="form-label">Select Target</label>
                            <select class="form-select" id="edit_target_id" name="target_id">
                                <option value="">None</option>
                                <!-- Options will be loaded dynamically based on the selected type -->
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="edit_title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="edit_title" name="title" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_message" class="form-label">Message</label>
                        <textarea class="form-control" id="edit_message" name="message" rows="3" required></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_reminder_date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="edit_reminder_date" name="reminder_date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_reminder_time" class="form-label">Time</label>
                            <input type="time" class="form-control" id="edit_reminder_time" name="reminder_time" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_repeat_interval" class="form-label">Repeat</label>
                            <select class="form-select" id="edit_repeat_interval" name="repeat_interval">
                                <option value="once">Once</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_notification_method" class="form-label">Notification Method</label>
                            <select class="form-select" id="edit_notification_method" name="notification_method">
                                <option value="app">App Notification</option>
                                <option value="email">Email</option>
                                <option value="sms">SMS</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active">
                        <label class="form-check-label" for="edit_is_active">
                            Active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateReminderBtn">Update Reminder</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        // Load reminders on page load
        await loadReminders();
        
        // Set up event listeners
        document.getElementById('applyFilters').addEventListener('click', loadReminders);
        document.getElementById('resetFilters').addEventListener('click', resetFilters);
        document.getElementById('saveReminderBtn').addEventListener('click', saveReminder);
        document.getElementById('updateReminderBtn').addEventListener('click', updateReminder);
        
        // Event listener for reminder type change
        document.getElementById('reminder_type').addEventListener('change', function() {
            loadTargetsForType(this.value);
        });
        
        document.getElementById('edit_reminder_type').addEventListener('change', function() {
            loadTargetsForType(this.value, 'edit_');
        });
    });
    
    async function loadReminders() {
        try {
            showLoader();
            
            // Get filter values
            const reminderType = document.getElementById('typeFilter').value;
            const isActive = document.getElementById('statusFilter').value;
            
            // Create filters object
            const filters = {};
            if (reminderType) filters.reminder_type = reminderType;
            if (isActive !== '') filters.is_active = isActive === 'true';
            
            // Fetch reminders
            const reminders = await fetchReminders(filters);
            
            // Display reminders
            const container = document.getElementById('reminders-container');
            
            if (reminders.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-5">
                        <h5>No reminders found</h5>
                        <p>Add a reminder to get started</p>
                    </div>
                `;
                hideLoader();
                return;
            }
            
            // Group reminders by type
            const remindersByType = {};
            
            reminders.forEach(reminder => {
                if (!remindersByType[reminder.reminder_type]) {
                    remindersByType[reminder.reminder_type] = [];
                }
                
                remindersByType[reminder.reminder_type].push(reminder);
            });
            
            let html = '';
            
            // Display each reminder type in its own section
            for (const [type, remindersOfType] of Object.entries(remindersByType)) {
                let typeDisplay = '';
                let iconClass = '';
                
                switch(type) {
                    case 'medication':
                        typeDisplay = 'Medication Reminders';
                        iconClass = 'fa-pills';
                        break;
                    case 'appointment':
                        typeDisplay = 'Appointment Reminders';
                        iconClass = 'fa-calendar-alt';
                        break;
                    case 'health_check':
                        typeDisplay = 'Health Check Reminders';
                        iconClass = 'fa-heartbeat';
                        break;
                    default:
                        typeDisplay = 'Other Reminders';
                        iconClass = 'fa-bell';
                }
                
                html += `
                    <div class="mb-4">
                        <h4><i class="fas ${iconClass} me-2"></i>${typeDisplay}</h4>
                        <div class="list-group">
                `;
                
                remindersOfType.forEach(reminder => {
                    const reminderDate = new Date(reminder.reminder_time);
                    const formattedDate = formatDate(reminderDate);
                    const formattedTime = formatTime(reminderDate);
                    
                    html += `
                        <div class="list-group-item ${!reminder.is_active ? 'list-group-item-light' : ''}">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${reminder.title}</h5>
                                <small class="text-muted">${reminder.repeat_interval}</small>
                            </div>
                            <p class="mb-1">${reminder.message}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="far fa-clock me-1"></i>${formattedDate} at ${formattedTime}
                                    <span class="ms-2 badge ${reminder.is_active ? 'bg-success' : 'bg-secondary'}">
                                        ${reminder.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                    <span class="ms-2 badge bg-info">
                                        ${reminder.notification_method}
                                    </span>
                                </small>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-primary" onclick="openEditModal(${reminder.id})">
                                        Edit
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteReminderConfirm(${reminder.id})">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            hideLoader();
            
        } catch (error) {
            console.error('Error loading reminders:', error);
            showAlert('Failed to load reminders. Please try again later.', 'danger');
            hideLoader();
        }
    }
    
    function resetFilters() {
        document.getElementById('typeFilter').value = '';
        document.getElementById('statusFilter').value = 'true';
        loadReminders();
    }
    
    async function loadTargetsForType(reminderType, prefix = '') {
        if (!reminderType) return;
        
        const targetIdSelect = document.getElementById(`${prefix}target_id`);
        targetIdSelect.innerHTML = '<option value="">None</option>';
        
        try {
            let endpoint = '';
            let nameField = '';
            
            switch(reminderType) {
                case 'medication':
                    endpoint = '/api/medications';
                    nameField = 'name';
                    break;
                case 'appointment':
                    endpoint = '/api/appointments';
                    nameField = 'title';
                    break;
                case 'health_check':
                    // Health checks don't have a specific target
                    return;
                default:
                    return;
            }
            
            // Fetch items
            const response = await fetch(endpoint);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            
            const items = await response.json();
            
            // Add options
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item[nameField];
                targetIdSelect.appendChild(option);
            });
            
        } catch (error) {
            console.error(`Error loading targets for ${reminderType}:`, error);
            showAlert(`Failed to load ${reminderType} targets. Please try again.`, 'warning');
        }
    }
    
    async function saveReminder() {
        // Validate form
        const title = document.getElementById('title').value;
        const message = document.getElementById('message').value;
        const reminderDate = document.getElementById('reminder_date').value;
        const reminderTime = document.getElementById('reminder_time').value;
        const reminderType = document.getElementById('reminder_type').value;
        
        if (!title || !message || !reminderDate || !reminderTime || !reminderType) {
            showAlert('Please fill in all required fields', 'warning');
            return;
        }
        
        // Combine date and time into a single datetime
        const reminderDateTime = new Date(`${reminderDate}T${reminderTime}`);
        
        const reminderData = {
            reminder_type: reminderType,
            target_id: document.getElementById('target_id').value || null,
            title: title,
            message: message,
            reminder_time: reminderDateTime.toISOString(),
            repeat_interval: document.getElementById('repeat_interval').value,
            notification_method: document.getElementById('notification_method').value,
            is_active: true
        };
        
        try {
            showLoader();
            const response = await fetch('/api/reminders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(reminderData),
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
            }
            
            hideLoader();
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('addReminderModal'));
            modal.hide();
            document.getElementById('addReminderForm').reset();
            
            showAlert('Reminder created successfully!', 'success');
            
            // Reload reminders
            await loadReminders();
            
        } catch (error) {
            hideLoader();
            console.error('Error saving reminder:', error);
            showAlert('Failed to save reminder. Please try again.', 'danger');
        }
    }
    
    function openEditModal(reminderId) {
        try {
            showLoader();
            
            fetch(`/api/reminders/${reminderId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(async reminder => {
                    hideLoader();
                    
                    // Fill form with reminder data
                    document.getElementById('edit_reminder_id').value = reminder.id;
                    document.getElementById('edit_reminder_type').value = reminder.reminder_type;
                    document.getElementById('edit_title').value = reminder.title;
                    document.getElementById('edit_message').value = reminder.message;
                    
                    // Format date and time for inputs
                    const reminderDate = new Date(reminder.reminder_time);
                    const formattedDate = reminderDate.toISOString().split('T')[0];
                    document.getElementById('edit_reminder_date').value = formattedDate;
                    
                    const hours = reminderDate.getHours().toString().padStart(2, '0');
                    const minutes = reminderDate.getMinutes().toString().padStart(2, '0');
                    document.getElementById('edit_reminder_time').value = `${hours}:${minutes}`;
                    
                    document.getElementById('edit_repeat_interval').value = reminder.repeat_interval;
                    document.getElementById('edit_notification_method').value = reminder.notification_method;
                    document.getElementById('edit_is_active').checked = reminder.is_active;
                    
                    // Load targets for the reminder type
                    await loadTargetsForType(reminder.reminder_type, 'edit_');
                    
                    // Set the target ID if available
                    if (reminder.target_id) {
                        document.getElementById('edit_target_id').value = reminder.target_id;
                    }
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('editReminderModal'));
                    modal.show();
                })
                .catch(error => {
                    hideLoader();
                    console.error('Error loading reminder details:', error);
                    showAlert('Failed to load reminder details. Please try again.', 'danger');
                });
            
        } catch (error) {
            hideLoader();
            console.error('Error loading reminder details:', error);
            showAlert('Failed to load reminder details. Please try again.', 'danger');
        }
    }
    
    async function updateReminder() {
        const reminderId = document.getElementById('edit_reminder_id').value;
        
        // Validate form
        const title = document.getElementById('edit_title').value;
        const message = document.getElementById('edit_message').value;
        const reminderDate = document.getElementById('edit_reminder_date').value;
        const reminderTime = document.getElementById('edit_reminder_time').value;
        
        if (!title || !message || !reminderDate || !reminderTime) {
            showAlert('Please fill in all required fields', 'warning');
            return;
        }
        
        // Combine date and time into a single datetime
        const reminderDateTime = new Date(`${reminderDate}T${reminderTime}`);
        
        const reminderData = {
            reminder_type: document.getElementById('edit_reminder_type').value,
            target_id: document.getElementById('edit_target_id').value || null,
            title: title,
            message: message,
            reminder_time: reminderDateTime.toISOString(),
            repeat_interval: document.getElementById('edit_repeat_interval').value,
            notification_method: document.getElementById('edit_notification_method').value,
            is_active: document.getElementById('edit_is_active').checked
        };
        
        try {
            showLoader();
            const response = await fetch(`/api/reminders/${reminderId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(reminderData),
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
            }
            
            hideLoader();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editReminderModal'));
            modal.hide();
            
            showAlert('Reminder updated successfully!', 'success');
            
            // Reload reminders
            await loadReminders();
            
        } catch (error) {
            hideLoader();
            console.error('Error updating reminder:', error);
            showAlert('Failed to update reminder. Please try again.', 'danger');
        }
    }
    
    async function deleteReminderConfirm(reminderId) {
        if (confirm('Are you sure you want to delete this reminder? This action cannot be undone.')) {
            try {
                showLoader();
                const response = await fetch(`/api/reminders/${reminderId}`, {
                    method: 'DELETE',
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                hideLoader();
                showAlert('Reminder deleted successfully!', 'success');
                
                // Reload reminders
                await loadReminders();
                
            } catch (error) {
                hideLoader();
                console.error('Error deleting reminder:', error);
                showAlert('Failed to delete reminder. Please try again.', 'danger');
            }
        }
    }
</script>
{% endblock %}